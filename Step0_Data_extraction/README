# README — CAR-T & IL-6 Individual Data Extraction Script

## Overview

This R script extracts **CAR-T cell counts** and **IL-6 concentrations** for a predefined set of patients from source CSV files and writes per-patient combined datasets.

For each patient ID, it:

1. Reads CAR-T data from `../data/<ID>-QSP.csv` or fallback `../data/<ID>-QSP-NEG.csv`.
2. Reads IL-6 data from `../data/<ID>-QSP-IL.csv` (if available).
3. Filters to `EVENT == "DV"` records and non-missing values.
4. Aligns CAR-T and IL-6 series **by row index** (not by time).
5. Renames columns to a standard format:
   - `Days`  (CAR-T time)
   - `CART`  (CAR-T measurement)
   - `days`  (IL-6 time)
   - `IL6`   (IL-6 measurement)
6. Writes a tab-delimited file:
   `./extracted_data/Individual_Data_<ID>_CART_IL6.csv`

This is meant for **downstream inspection / pattern checking**, not for statistically safe pooled modeling as written (see limitations).

---

## Requirements

- R (≥ 4.x recommended)
- Packages:
  - `dplyr`
  - `tidyr`
  - (If you switch from `data_frame()` to modern syntax, use `tibble` or base `data.frame`.)

Install dependencies:

```r
install.packages(c("dplyr", "tidyr"))
```

---

## Expected Directory Structure

Run the script from a directory where:

- Input files live in `../data/`
- Output files will be written to `./extracted_data/`

Example:

```text
project_root/
  data/
    L1-QSP.csv
    L1-QSP-IL.csv
    ...
  scripts/
    extract_CART_IL6.R   # this script
  extracted_data/
    # created/filled by the script
```

If `./extracted_data` doesn’t exist, create it before running:

```bash
mkdir -p extracted_data
```

---

## Input File Naming & Format

For each `patient` in:

```r
Patients_lable <- c(
  "L1","L2","L3","L4","L6","L7",
  "P01","P02","P03","P05","P09","P10","P12",
  "M03","M09","M21","M57","M68",
  "G01","P22","M04","M19","M26","M44","G02"
)
```

the script expects:

1. **CAR-T data**

   - Primary:  `../data/<ID>-QSP.csv`
   - Fallback: `../data/<ID>-QSP-NEG.csv` (used only if primary is missing)

   Required columns:
   - `EVENT` (e.g. `"DV"`)
   - `TIME`  (numeric; time since infusion)
   - `DV.CART` (numeric; CAR-T measurement)

2. **IL-6 data (optional)**

   - `../data/<ID>-QSP-IL.csv`

   Required columns (if file exists):
   - `EVENT`
   - `TIME`
   - `DV.IL6`

Rows are filtered to:

- `EVENT == "DV"`
- non-`NA` `DV.CART` or `DV.IL6` values.

If the IL-6 file does **not** exist, the script currently creates a placeholder with `TIME = NA`, `DV.IL6 = NA` so that the join step still runs.

---

## Output

For each patient, the script writes:

```text
./extracted_data/Individual_Data_<ID>_CART_IL6.csv
```

Where `<ID>` is normalized to keep a zero-padded number if present
(e.g. `P1` → `P01`, `M3` → `M03`).

Each output file has 4 columns:

1. `Days` — CAR-T time points
2. `CART` — CAR-T observations
3. `days` — IL-6 time points (row-aligned)
4. `IL6` — IL-6 observations

---

## How to Run

From the script directory (or adjust paths accordingly):

```bash
Rscript extract_CART_IL6.R
```

Make sure:

- Input files exist and match the expected naming scheme.
- `extracted_data/` directory is present or created beforehand.

---

## Important Limitations

This script does a **row-index join**:

```r
full_join(
  CAR_Date %>% mutate(.row = row_number()),
  IL6_Date %>% mutate(.row = row_number()),
  by = ".row"
)
```

That means:

- 1st CAR-T record is paired with 1st IL-6 record,
- 2nd with 2nd, etc.,
- regardless of whether the **time points match**.

This is only acceptable if:

- CAR-T and IL-6 data are already ordered and sampled in a matched way for each patient.

If time grids differ (which is common), this approach **misaligns data** and should **not** be used for quantitative fitting. You would instead:

- join by actual time (with tolerance), or
- keep data in long format with a `PATIENT` column.

If you expect misaligned sampling and still use this script, that’s on you.

---

## Notes / Possible Improvements

- Replace deprecated `data_frame()` with `tibble()` or `data.frame()`.
- Add a `PATIENT` column into outputs if used downstream.
- Add time-based joins instead of row-based, if you care about correctness.
- Automatically create `extracted_data/` if missing.

---

**End of README**
